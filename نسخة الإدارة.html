<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة الورش التدريبية - LocalStorage</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
h1 { text-align: center; }
.card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 10px; text-align: center; }
input { padding: 8px; border-radius: 8px; border: 1px solid #aaa; width: 100%; box-sizing: border-box }
button { padding: 8px 14px; border: none; border-radius: 8px; background: #007bff; color: white; cursor: pointer; margin: 5px; }
button:hover { background: #0056b3; }
.del-btn { background: #d9534f; }
.del-btn:hover { background: #b52b27; }
.small-btn { padding: 6px 10px; border-radius: 6px; }
ul { text-align: right; padding-right: 10px; margin:0; }
</style>
</head>
<body>

<h1>إدارة الورش التدريبية - LocalStorage</h1>

<div class="card">
  <h2>إضافة موظف جديد</h2>
  <input type="text" id="empName" placeholder="أدخل اسم الموظف" />
  <br><br>
  <h3>إضافة ورشة مؤقتة قبل الحفظ</h3>
  <input type="text" id="workshopName" placeholder="اسم الورشة" />
  <input type="date" id="workshopStart" />
  <input type="date" id="workshopEnd" />
  <button onclick="addWorkshop()">إضافة ورشة</button>
  <h4>الورش المضافة مؤقتاً:</h4>
  <ul id="tempList"></ul>
  <button onclick="addEmployee()">حفظ الموظف</button>
</div>

<div class="card">
<h2>بحث الموظفين</h2>
<input type="text" id="searchInput" placeholder="أدخل اسم الموظف للبحث" oninput="renderFiltered()" />
</div>

<div class="card">
<button onclick="exportToExcel()">تصدير البيانات إلى Excel</button>
<h2>قائمة الموظفين</h2>
<table>
  <thead>
    <tr>
      <th>الاسم</th>
      <th>عدد الورش</th>
      <th>تفاصيل الورش</th>
      <th>إضافة ورشة</th>
      <th>حذف</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>
</div>

<script>
let tempWorkshops = [];
let employees = [];

// تحميل البيانات من LocalStorage عند فتح الصفحة
function loadLocal() {
  const data = localStorage.getItem("employees");
  if (data) employees = JSON.parse(data);
  renderFiltered();
}

// حفظ البيانات في LocalStorage
function saveLocal() {
  localStorage.setItem("employees", JSON.stringify(employees));
}

// إضافة ورشة مؤقتة
function addWorkshop() {
  const wName = document.getElementById("workshopName").value.trim();
  const wStart = document.getElementById("workshopStart").value;
  const wEnd = document.getElementById("workshopEnd").value;
  if (!wName || !wStart || !wEnd) { alert("يرجى تعبئة جميع بيانات الورشة"); return; }
  if (wEnd < wStart) { alert("تاريخ النهاية لا يمكن أن يكون قبل البداية"); return; }
  tempWorkshops.push({ name: wName, start: wStart, end: wEnd });
  renderTemp();
  document.getElementById("workshopName").value = "";
  document.getElementById("workshopStart").value = "";
  document.getElementById("workshopEnd").value = "";
}

function renderTemp() {
  const ul = document.getElementById("tempList");
  ul.innerHTML = "";
  tempWorkshops.forEach((w, i) => {
    ul.innerHTML += `<li>${w.name} — ${w.start} إلى ${w.end} <button class='small-btn' onclick='removeTemp(${i})'>حذف</button></li>`;
  });
}

function removeTemp(i) { tempWorkshops.splice(i,1); renderTemp(); }

// إضافة موظف
function addEmployee() {
  const name = document.getElementById("empName").value.trim();
  if (!name) { alert("يرجى إدخال اسم الموظف"); return; }
  employees.push({ name, workshops: tempWorkshops });
  tempWorkshops = [];
  document.getElementById("empName").value = "";
  renderTemp();
  saveLocal();
  renderFiltered();
}

// حذف موظف
function deleteEmployee(index) {
  if (confirm("هل أنت متأكد من حذف الموظف؟")) {
    employees.splice(index,1);
    saveLocal();
    renderFiltered();
  }
}

// إضافة ورشة لموظف موجود
function addWorkshopToEmployee(index) {
  const wName = prompt("أدخل اسم الورشة:");
  if (!wName) return;
  const wStart = prompt("أدخل تاريخ البداية (YYYY-MM-DD):");
  if (!wStart) return;
  const wEnd = prompt("أدخل تاريخ النهاية (YYYY-MM-DD):");
  if (!wEnd) return;
  if (wEnd < wStart) { alert('تاريخ النهاية لا يمكن أن يكون قبل البداية'); return; }

  employees[index].workshops.push({ name: wName, start: wStart, end: wEnd });
  saveLocal();
  renderFiltered();
}

// عرض البيانات حسب البحث
function renderFiltered() {
  const query = document.getElementById("searchInput").value.trim().toLowerCase();
  const tableBody = document.getElementById("tableBody");
  tableBody.innerHTML = "";

  employees.forEach((emp, index) => {
    if (emp.name.toLowerCase().includes(query)) {
      let list = "<ul>";
      emp.workshops.forEach(w => list += `<li>${w.name} — ${w.start} إلى ${w.end}</li>`);
      list += "</ul>";
      tableBody.innerHTML += `<tr>
        <td>${emp.name}</td>
        <td>${emp.workshops.length}</td>
        <td>${list}</td>
        <td><button class='small-btn' onclick='addWorkshopToEmployee(${index})'>+</button></td>
        <td><button class='del-btn' onclick='deleteEmployee(${index})'>حذف</button></td>
      </tr>`;
    }
  });
}

// تصدير البيانات إلى Excel
function exportToExcel() {
  const worksheetData = [];
  employees.forEach(emp => {
    if (!emp.workshops || emp.workshops.length === 0) {
      worksheetData.push({ "اسم الموظف": emp.name, "اسم الورشة": "", "تاريخ البداية": "", "تاريخ النهاية": "" });
    } else {
      emp.workshops.forEach(w => worksheetData.push({
        "اسم الموظف": emp.name,
        "اسم الورشة": w.name,
        "تاريخ البداية": w.start,
        "تاريخ النهاية": w.end
      }));
    }
  });
  const worksheet = XLSX.utils.json_to_sheet(worksheetData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "الورش");
  XLSX.writeFile(workbook, "training_data.xlsx");
}

// تحميل البيانات عند فتح الصفحة
loadLocal();
</script>

</body>
</html>
